import{a as k}from"./chunk-54KZWHWX.js";import{A as u,B as S,F as f,Ha as w,I as m,Ia as F,L as t,M as o,N as b,O as E,P,Q as U,R as C,S as d,U as O,V as n,W as l,X as p,ea as x,ga as h,ha as y,oa as N,p as v,pa as M,q as _,ra as T,sa as D,x as I,y as a}from"./chunk-M6YUWBB5.js";import"./chunk-42NE2CY3.js";function R(r,i){r&1&&(t(0,"div",5),n(1," Cargando intercambios... "),o())}function $(r,i){if(r&1&&(t(0,"div",6),n(1),o()),r&2){let e=d();a(),p(" ",e.error," ")}}function z(r,i){r&1&&(t(0,"div",9)(1,"p"),n(2,"No tienes intercambios en proceso de confirmaci\xF3n."),o()())}function V(r,i){if(r&1&&(E(0),n(1),P()),r&2){let e=d().$implicit,c=d(2);a(),p(" ",c.getUserNameById(c.currentUserId===e.idUsuarioSolicitante?e.idUsuarioPropietario:e.idUsuarioSolicitante)," ")}}function j(r,i){r&1&&b(0,"span",25)}function B(r,i){if(r&1){let e=U();t(0,"div")(1,"button",26),C("click",function(){v(e);let s=d().$implicit,g=d(2);return _(g.confirmarIntercambio(s.id))}),n(2,"\u2705 Confirmar recepci\xF3n"),o(),t(3,"button",27),C("click",function(){v(e);let s=d().$implicit,g=d(2);return _(g.revertirIntercambio(s.id))}),n(4,"\u21A9\uFE0F Revertir"),o()()}}function q(r,i){r&1&&(t(0,"div")(1,"span",28),n(2,"\u23F3 Esperando tu confirmaci\xF3n..."),o()())}function L(r,i){r&1&&(t(0,"div")(1,"span",28),n(2,"\u23F3 Esperando confirmaci\xF3n del otro usuario..."),o()())}function G(r,i){r&1&&(t(0,"div")(1,"span",29),n(2,"\u{1F389} Intercambio finalizado y aprobado"),o()())}function H(r,i){r&1&&(t(0,"div")(1,"span",30),n(2,"\u274C Intercambio cancelado/devuelto"),o()())}function J(r,i){if(r&1&&(t(0,"div",10)(1,"div",11)(2,"h3"),n(3," Intercambio con "),f(4,V,2,1,"ng-container",12)(5,j,1,0,"ng-template",null,0,y),o(),t(7,"span",13),n(8),o()(),t(9,"div",14)(10,"div",15)(11,"h4"),n(12,"Tu Producto"),o(),t(13,"div",16),b(14,"img",17),t(15,"div",18)(16,"h5"),n(17),o(),t(18,"p"),n(19),o(),t(20,"p",19),n(21),x(22,"currency"),o()()()(),t(23,"div",20),n(24,"\u21C4"),o(),t(25,"div",21)(26,"h4"),n(27,"Producto del otro usuario"),o(),t(28,"div",16),b(29,"img",17),t(30,"div",18)(31,"h5"),n(32),o(),t(33,"p"),n(34),o(),t(35,"p",19),n(36),x(37,"currency"),o()()()()(),t(38,"div",22)(39,"div",23)(40,"span"),n(41," Tu confirmaci\xF3n: "),t(42,"b"),n(43),o()(),t(44,"span"),n(45," Confirmaci\xF3n del otro usuario: "),t(46,"b"),n(47),o()()(),f(48,B,5,0,"div",4)(49,q,3,0,"div",4)(50,L,3,0,"div",4)(51,G,3,0,"div",4)(52,H,3,0,"div",4),t(53,"div",24)(54,"small"),n(55),o()()()()),r&2){let e=i.$implicit,c=O(6),s=d(2);a(4),m("ngIf",s.getUserNameById(s.currentUserId===e.idUsuarioSolicitante?e.idUsuarioPropietario:e.idUsuarioSolicitante))("ngIfElse",c),a(4),p("Estado: ",e.estadoIntercambio,""),a(6),m("src",e.productoSolicitado.urlFoto||"assets/no-image.png",I)("alt",e.productoSolicitado.titulo),a(3),l(e.productoSolicitado.titulo),a(2),l(e.productoSolicitado.descripcion),a(2),l(h(22,21,e.productoSolicitado.precio,"USD","symbol","1.0-0")),a(8),m("src",e.productoOfrecido.urlFoto||"assets/no-image.png",I)("alt",e.productoOfrecido.titulo),a(3),l(e.productoOfrecido.titulo),a(2),l(e.productoOfrecido.descripcion),a(2),l(h(37,26,e.productoOfrecido.precio,"USD","symbol","1.0-0")),a(7),p(" ",s.currentUserId===e.idUsuarioPropietario?e.confirmacionPropietario:e.confirmacionSolicitante," "),a(4),p(" ",s.currentUserId===e.idUsuarioPropietario?e.confirmacionSolicitante:e.confirmacionPropietario," "),a(),m("ngIf",e.idUsuarioPropietario===s.currentUserId&&e.confirmacionPropietario==="PENDIENTE"||e.idUsuarioSolicitante===s.currentUserId&&e.confirmacionSolicitante==="PENDIENTE"),a(),m("ngIf",s.esMiConfirmacionPendiente(e)),a(),m("ngIf",s.esConfirmacionPendienteDelOtro(e)),a(),m("ngIf",e.confirmacionPropietario==="CONFIRMADO"&&e.confirmacionSolicitante==="CONFIRMADO"),a(),m("ngIf",e.confirmacionPropietario==="REVERTIDO"||e.confirmacionSolicitante==="REVERTIDO"),a(3),p("Intercambio iniciado: ",s.formatDate(e.fechaCreacion),"")}}function K(r,i){if(r&1&&(t(0,"div"),f(1,z,3,0,"div",7)(2,J,56,31,"div",8),o()),r&2){let e=d();a(),m("ngIf",e.intercambios.length===0),a(),m("ngForOf",e.intercambios)}}var A=class r{constructor(i,e,c){this.apiService=i;this.authService=e;this.userService=c}intercambios=[];loading=!0;error=null;currentUserId=null;userNames={};loadingNames=new Set;ngOnInit(){console.log("[ConfirmarIntercambios] ngOnInit");let i=localStorage.getItem("userId");this.currentUserId=i?Number(i):null,console.log("[ConfirmarIntercambios] currentUserId:",this.currentUserId),this.currentUserId?this.loadIntercambios():(this.error="No se pudo obtener el usuario actual",this.loading=!1)}loadIntercambios(){this.loading=!0,this.error=null,console.log("[ConfirmarIntercambios] loadIntercambios, currentUserId:",this.currentUserId),Promise.all([this.apiService.getOfertasRecibidas(this.currentUserId).toPromise(),this.apiService.getOfertasEnviadas(this.currentUserId).toPromise()]).then(([i,e])=>{console.log("[ConfirmarIntercambios] Ofertas recibidas:",i),console.log("[ConfirmarIntercambios] Ofertas enviadas:",e),this.intercambios=[...i,...e].filter(c=>c.estadoIntercambio==="ACEPTADO"||c.estadoIntercambio==="PROCESO"),this.loading=!1,console.log("[ConfirmarIntercambios] Intercambios a mostrar:",this.intercambios)}).catch(i=>{this.error="Error al cargar los intercambios",this.loading=!1,console.error("[ConfirmarIntercambios] Error al cargar intercambios:",i)})}confirmarIntercambio(i){this.currentUserId&&confirm("\xBFConfirmas que recibiste el producto y el intercambio fue exitoso?")&&this.apiService.confirmarIntercambio(i,this.currentUserId).subscribe({next:()=>{alert("\xA1Intercambio confirmado!"),this.loadIntercambios()},error:e=>{alert(e.error||"Error al confirmar el intercambio")}})}revertirIntercambio(i){this.currentUserId&&confirm("\xBFSeguro que quieres revertir el intercambio y devolver el producto a publicado?")&&this.apiService.revertirIntercambio(i,this.currentUserId).subscribe({next:()=>{alert("Intercambio revertido. El producto vuelve a estar publicado."),this.loadIntercambios()},error:e=>{alert(e.error||"Error al revertir el intercambio")}})}formatDate(i){return new Date(i).toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}getUserNameById(i){return this.userNames[i]?this.userNames[i]:(this.loadingNames.has(i)||(this.loadingNames.add(i),this.userService.getUsuarioPorId(i).then(e=>{e&&e.primerNombre&&e.apellidoPaterno?this.userNames[i]=`${e.primerNombre} ${e.apellidoPaterno}`:e&&e.primerNombre?this.userNames[i]=e.primerNombre:this.userNames[i]="Usuario "+i,this.loadingNames.delete(i)})),"")}getConfirmarEndpoint(i){return`/api/intercambios/${i}/confirmar?userId=${this.currentUserId}`}getRevertirEndpoint(i){return`/api/intercambios/${i}/revertir?userId=${this.currentUserId}`}esMiConfirmacionPendiente(i){return this.currentUserId===i.idUsuarioPropietario?i.confirmacionPropietario==="PENDIENTE":this.currentUserId===i.idUsuarioSolicitante?i.confirmacionSolicitante==="PENDIENTE":!1}esConfirmacionPendienteDelOtro(i){return this.currentUserId===i.idUsuarioPropietario?i.confirmacionSolicitante==="PENDIENTE":this.currentUserId===i.idUsuarioSolicitante?i.confirmacionPropietario==="PENDIENTE":!1}static \u0275fac=function(e){return new(e||r)(u(k),u(w),u(F))};static \u0275cmp=S({type:r,selectors:[["app-confirmar-intercambios"]],decls:8,vars:3,consts:[["loadingName",""],[1,"confirmar-intercambios-panel"],["class","loading",4,"ngIf"],["class","error",4,"ngIf"],[4,"ngIf"],[1,"loading"],[1,"error"],["class","no-intercambios",4,"ngIf"],["class","intercambio-card",4,"ngFor","ngForOf"],[1,"no-intercambios"],[1,"intercambio-card"],[1,"intercambio-header"],[4,"ngIf","ngIfElse"],[1,"estado"],[1,"productos-comparison"],[1,"producto-solicitado"],[1,"producto-info"],[3,"src","alt"],[1,"producto-details"],[1,"price"],[1,"intercambio-arrow"],[1,"producto-ofrecido"],[1,"intercambio-footer"],[1,"confirmacion-info"],[1,"intercambio-date"],[1,"spinner-small"],[1,"btn-aceptar",3,"click"],[1,"btn-rechazar",3,"click"],[1,"status-wait"],[1,"status-finalizado"],[1,"status-revertido"]],template:function(e,c){e&1&&(t(0,"div",1)(1,"h2"),n(2,"Confirmar Intercambios"),o(),t(3,"p"),n(4,"Confirma o revierte los intercambios que tienes en proceso."),o(),f(5,R,2,0,"div",2)(6,$,2,1,"div",3)(7,K,3,2,"div",4),o()),e&2&&(a(5),m("ngIf",c.loading),a(),m("ngIf",c.error),a(),m("ngIf",!c.loading&&!c.error))},dependencies:[D,N,M,T],styles:[".confirmar-intercambios-panel[_ngcontent-%COMP%]{max-width:900px;margin:0 auto;padding:2rem;background:#fff;border-radius:10px;box-shadow:0 2px 8px #00000012}.intercambio-card[_ngcontent-%COMP%]{border:1px solid #e0e0e0;border-radius:8px;margin-bottom:2rem;padding:1rem;background:#f9f9f9}.intercambio-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}.productos-comparison[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between}.producto-solicitado[_ngcontent-%COMP%], .producto-ofrecido[_ngcontent-%COMP%]{width:40%}.producto-info[_ngcontent-%COMP%]{display:flex;align-items:center}.producto-info[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:80px;height:80px;object-fit:cover;border-radius:8px;margin-right:1rem;background:#eee}.intercambio-arrow[_ngcontent-%COMP%]{font-size:2rem;color:#888;margin:0 1rem}.confirmacion-info[_ngcontent-%COMP%]{margin-bottom:1rem;font-size:1rem}.btn-aceptar[_ngcontent-%COMP%]{background:#4caf50;color:#fff;border:none;padding:.5rem 1.2rem;border-radius:5px;margin-right:.5rem;cursor:pointer}.btn-rechazar[_ngcontent-%COMP%]{background:#e53935;color:#fff;border:none;padding:.5rem 1.2rem;border-radius:5px;cursor:pointer}.status-finalizado[_ngcontent-%COMP%]{color:#388e3c;font-weight:700}.status-revertido[_ngcontent-%COMP%]{color:#e53935;font-weight:700}.status-wait[_ngcontent-%COMP%]{color:#fbc02d;font-weight:700}.loading[_ngcontent-%COMP%], .error[_ngcontent-%COMP%], .no-intercambios[_ngcontent-%COMP%]{text-align:center;margin:2rem 0;color:#888}.spinner-small[_ngcontent-%COMP%]{display:inline-block;width:18px;height:18px;border:2px solid #ccc;border-top:2px solid #1976d2;border-radius:50%;animation:_ngcontent-%COMP%_spin .7s linear infinite;vertical-align:middle}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}"]})};export{A as ConfirmarIntercambiosComponent};
